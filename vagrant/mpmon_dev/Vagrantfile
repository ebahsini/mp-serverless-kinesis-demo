# -*- mode: ruby -*-
# vi: set ft=ruby :

VAGRANTFILE_API_VERSION = '2'

# how much ram the virtual machine should have
# export $MPMON_MEMORY to override the default
MPMON_MEMORY = ENV['MPMON_MEMORY'] ||= '1024'

IP_ADDRESS = {
  :mpmon_dev => '192.168.251.48'
}

BOX_SOURCE = 'http://cloud-images.ubuntu.com/'
BOX_TYPE = 'vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box'
ANSIBLE_PLAYBOOK = '../../ansible/playbooks/dev_aws_fullstack.yml'

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.define :mpmon_dev do |mpmon|
    mpmon.vm.box = 'trusty'
    mpmon.vm.box_url = BOX_SOURCE + BOX_TYPE
    mpmon.vm.network "private_network", ip: IP_ADDRESS[:mpmon_dev]
    mpmon.vm.hostname = "mpmon-dev"

    # use all available cpu cores
    host = RbConfig::CONFIG['host_os']
    if host =~ /darwin/
      cpus = `sysctl -n hw.ncpu`.to_i
    elsif host =~ /linux/
      cpus = `nproc`.to_i
    else
      cpus = 1
    end

    mpmon.vm.provider :virtualbox do |vb|
      vb.customize ['modifyvm', :id, '--cpus', cpus]
      vb.customize ['modifyvm', :id, '--memory', MPMON_MEMORY]
      vb.customize ['guestproperty', 'set', :id,
                    '/VirtualBox/GuestAdd/VBoxService/--timesync-set-threshold', 300000]
    end

    mpmon.vm.synced_folder '../../backend/', '/opt/backend'
    mpmon.vm.synced_folder '../../frontend/', '/opt/frontend'

    mpmon.vm.provision 'ansible' do |ansible|
      ansible.inventory_path = 'hosts'
      ansible.playbook = ANSIBLE_PLAYBOOK
      ansible.host_key_checking = false
    end
  end
end
